<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soda Tracker - Dashboard</title>
    <style>
        /* CSS from your original file */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #fef5e7 0%, #fdebd0 50%, #fadbd8 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            text-align: center; color: #2c3e50; margin-bottom: 3rem;
            background: white; padding: 2rem; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .header h1 {
            font-size: 2.5rem; margin-bottom: 0.5rem; font-weight: 700;
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .header h1 .year {
            text-decoration: underline; text-decoration-color: #e67e22;
            text-decoration-thickness: 3px; text-underline-offset: 5px;
        }
        .header .subtitle {
            font-size: 1.2rem; opacity: 0.8; font-weight: 400; font-style: italic; color: #34495e;
        }
        .stats-section {
            background: white; padding: 2rem; margin-bottom: 2rem;
            border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .stats-section h2 { margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.8rem; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white; padding: 2rem; border-radius: 12px; text-align: center;
            box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(230, 126, 34, 0.4); }
        .stat-card h3 {
            font-size: 1rem; margin-bottom: 0.75rem; opacity: 0.9;
            font-weight: 500; text-transform: uppercase; letter-spacing: 1px;
        }
        .stat-value { font-size: 3rem; font-weight: 700; line-height: 1; }
        .stat-unit { font-size: 1rem; opacity: 0.8; margin-top: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th {
            background-color: #fef5e7; font-weight: 600; color: #2c3e50;
            font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        tr:hover { background-color: #fef5e7; }
        td { font-size: 1rem; }
        .soda-name { font-weight: 600; color: #2c3e50; }
        .number-cell { font-weight: 600; color: #e67e22; }
        .chart-container { position: relative; height: 400px; margin-bottom: 1.5rem; }
        .chart-controls { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .time-range-btn {
            padding: 0.75rem 1.5rem; border: 2px solid #e67e22; background: white;
            color: #e67e22; border-radius: 8px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease;
        }
        .time-range-btn:hover {
            background: #fef5e7; transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(230, 126, 34, 0.2);
        }
        .time-range-btn.active {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white; border-color: #e67e22; box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
        }
        
        /* Mobile Breakpoints */
        @media (max-width: 768px) {
            body { padding: 1rem 0.5rem; }
            .header h1 { font-size: 1.5rem; }
            .stats-grid { grid-template-columns: 1fr; }
            table { display: block; overflow-x: auto; }
            .chart-container { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        
<div class="header">
    <h1>During the <span class="year">2026</span> season, Liam Drank How Much??</h1>
    <p class="subtitle">The most important statistics in FRC</p>
</div>

<div class="stats-section">
    <h2>Overall Statistics</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Cans</h3>
            <div id="total-cans" class="stat-value">0</div>
            <div class="stat-unit">cans consumed</div>
        </div>
        <div class="stat-card">
            <h3>Total Sugar</h3>
            <div id="total-sugar" class="stat-value">0</div>
            <div class="stat-unit">grams</div>
        </div>
        <div class="stat-card">
            <h3>Total Caffeine</h3>
            <div id="total-caffeine" class="stat-value">0</div>
            <div class="stat-unit">milligrams</div>
        </div>
        <div class="stat-card">
            <h3>Total Calories</h3>
            <div id="total-calories" class="stat-value">0</div>
            <div class="stat-unit">kcal</div>
        </div>
        <div class="stat-card">
            <h3>Recycling Value</h3>
            <div id="recycling-value" class="stat-value">$0.00</div>
            <div class="stat-unit">earned back</div>
        </div>
    </div>
</div>

<div class="stats-section">
    <h2>Consumption by Type</h2>
    <table id="soda-table">
        <thead>
            <tr>
                <th>Soda Type</th>
                <th>Cans</th>
                <th>Sugar (g)</th>
                <th>Caffeine (mg)</th>
                <th>Calories</th>
                <th>Recycling Value</th>
            </tr>
        </thead>
        <tbody id="soda-table-body">
            
            
        </tbody>
    </table>
</div>

<div class="stats-section">
    <h2>Daily Consumption Trend</h2>
    <div class="chart-container">
        <canvas id="sodaChart"></canvas>
    </div>
    <div class="chart-controls">
        <button data-range="week" class="time-range-btn active">Last 7 Days</button>
        <button data-range="month" class="time-range-btn">Last 30 Days</button>
        <button data-range="season" class="time-range-btn">Full Season</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // --- GOOGLE DOCS IMPORT ---
    // Imports the soda consumption data from a Google Sheet

    const SHEET_ID = '1UA9edau7Zq3coGya3BTKkDfbAidJtp_O0oNkZ_qzEbg';
    // Note: replace 'Logs' and 'Facts' with your actual tab names
    const LOGS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Logs`;
    const FACTS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Facts`;

    async function initDashboard() {
        try {
            const [logsRes, factsRes] = await Promise.all([fetch(LOGS_URL), fetch(FACTS_URL)]);
            const logsText = await logsRes.text();
            const factsText = await factsRes.text();

            // Helper to strip Google's JSON wrapper
            const parse = (txt) => JSON.parse(txt.match(/(?<="table":).*(?=}\);)/g)[0]);
            
            const logsData = parse(logsText).rows;
            const factsData = parse(factsText).rows;

            // 1. Map Nutritional Facts (Name -> {sugar, caffeine, calories, value})
            const factsMap = {};
            factsData.forEach(row => {
                const name = row.c[0]?.v;
                factsMap[name] = {
                    sugar: row.c[1]?.v || 0,
                    caffeine: row.c[2]?.v || 0,
                    calories: row.c[3]?.v || 0,
                    value: row.c[4]?.v || 0
                };
            });

            // 2. Process Logs & Aggregate
            const summary = {};
            const dailyCounts = {}; // For the chart

            logsData.forEach(row => {
                const dateStr = row.c[0]?.f || row.c[0]?.v; // "Date" column
                const qty = row.c[1]?.v || 0;             // "Quantity" column
                const name = row.c[2]?.v;                 // "Name" column

                // Aggregate for Table
                if (!summary[name]) summary[name] = { qty: 0, sugar: 0, caffeine: 0, calories: 0, value: 0 };
                const nutritional = factsMap[name] || { sugar: 0, caffeine: 0, calories: 0, value: 0 };
                
                summary[name].qty += qty;
                summary[name].sugar += (qty * nutritional.sugar);
                summary[name].caffeine += (qty * nutritional.caffeine);
                summary[name].calories += (qty * nutritional.calories);
                summary[name].value += (qty * nutritional.value);

                // Aggregate for Chart (by date)
                dailyCounts[dateStr] = (dailyCounts[dateStr] || 0) + qty;
            });
    
            renderTable(summary);
            initChartData(dailyCounts);
            createChart('week');
        } catch (err) {
            console.error("Data sync failed:", err);
        }
    }

    function renderTable(summary) {
        const tbody = document.getElementById('soda-table-body');
        let totalCans = 0, totalSugar = 0, totalVal = 0, totalCaffeine = 0, totalCalories = 0;

        Object.entries(summary).forEach(([name, data]) => {
            totalCans += data.qty;
            totalSugar += data.sugar;
            totalVal += data.value;
            totalCaffeine += data.caffeine;
            totalCalories += data.calories;

            tbody.innerHTML += `
                <tr>
                    <td class="soda-name">${name}</td>
                    <td class="number-cell">${data.qty}</td>
                    <td class="number-cell">${data.sugar.toFixed(0)}g</td>
                    <td class="number-cell">${data.caffeine.toFixed(1)}mg</td>
                    <td class="number-cell">${data.calories.toFixed(0)}</td>
                    <td class="number-cell">$${data.value.toFixed(2)}</td>
                </tr>`;
        });

        document.getElementById('total-cans').innerText = totalCans;
        document.getElementById('total-sugar').innerText = totalSugar.toFixed(0);
        document.getElementById('total-caffeine').innerText = totalCaffeine.toFixed(1);
        document.getElementById('total-calories').innerText = totalCalories.toFixed(0);
        document.getElementById('recycling-value').innerText = `$${totalVal.toFixed(2)}`;
    }
    // --- STATISTICS LOGIC ---
    // This runs on the client side to sum up the table rows generated by Nunjucks
    function updateOverallStatistics() {
        const tableRows = document.querySelectorAll('#soda-table tbody tr');
        let totalCans = 0;
        let totalSugar = 0;
        let totalCaffeine = 0;
        let totalCalories = 0;
        let totalRecyclingValue = 0;

        tableRows.forEach(row => {
            const cells = row.cells;
            // The logic matches your original structure:
            // cells[1] = count, cells[2] = sugar, cells[3] = caffeine, cells[4] = calories, cells[5] = value ($)
            
            const cans = parseInt(cells[1].textContent) || 0;
            const sugar = parseFloat(cells[2].textContent) || 0;
            const caffeine = parseFloat(cells[3].textContent) || 0;
            const calories = parseFloat(cells[4].textContent) || 0;
            const recycling = parseFloat(cells[5].textContent.replace("$", "")) || 0;

            totalCans += cans;
            totalSugar += sugar;
            totalCaffeine += caffeine;
            totalCalories += calories;
            totalRecyclingValue += recycling;
        });

        document.getElementById("total-cans").textContent = totalCans;
        document.getElementById("total-sugar").textContent = totalSugar.toFixed(0);
        document.getElementById("total-caffeine").textContent = totalCaffeine.toFixed(1);
        document.getElementById("total-calories").textContent = totalCalories.toFixed(0);
        document.getElementById("recycling-value").textContent = "$" + totalRecyclingValue.toFixed(2);
    }

    const chartData = {
        week: { labels: [], data: [] },
        month: { labels: [], data: [] },
        season: { labels: [], data: [] }
    };

    function initChartData(dailyCounts) {
        const rawDates = Object.keys(dailyCounts).sort((a, b) => new Date(a) - new Date(b));
        
        if (rawDates.length === 0) return;

        const allDates = [];
        const allCounts = [];
        
        // 1. Define the start and end of your range
        let currentDate = new Date(rawDates[0]);
        const lastDate = new Date(rawDates[rawDates.length - 1]);

        // 2. Loop through every single day
        while (currentDate <= lastDate) {
            // Format key to match your hashmap format (likely YYYY-MM-DD)
            const dateStr = currentDate.toLocaleDateString('en-US', {
                month: 'numeric',
                day: 'numeric',
                year: 'numeric'
            });;
            allDates.push(dateStr);
            // 3. Use the count if it exists, otherwise default to 0
            allCounts.push(dailyCounts[dateStr] || 0);
            // Increment by 1 day
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Helper to slice and format labels
        const getRange = (days) => {
            const sliceSize = days === 0 ? 0 : -days;
            return {
                labels: allDates.slice(sliceSize).map(d => 
                    new Date(d).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })
                ),
                data: allCounts.slice(sliceSize)
            };
        };

        // Populate your chartData object
        chartData.week = getRange(7);
        chartData.month = getRange(30);
        chartData.season = getRange(0); // '0' to take the full sorted range
        
    }

    let currentChart = null;

    function createChart(range) {
        const ctx = document.getElementById('sodaChart').getContext('2d');
        if (currentChart) currentChart.destroy();

        const data = chartData[range];
        console.log(chartData);

        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Cans of Soda',
                    data: data.data,
                    borderColor: '#e67e22',
                    backgroundColor: 'rgba(230, 126, 34, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#e67e22',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(44, 62, 80, 0.95)',
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y === 1 ? '1 can' : context.parsed.y + ' cans';
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        initDashboard();
        updateOverallStatistics();
    });

    document.querySelectorAll('.time-range-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            createChart(this.dataset.range);
        });
    });
</script>
    </div>

</body>
</html>